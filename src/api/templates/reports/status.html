<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Status Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/cycle_report.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='image/favicon.ico') }}"
    />
    <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chartjs-plugin-datalabels.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cycle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/reports.js') }}"></script>
  </head>

  <body class="mat-typography">
    <!-- Global Variables Needed -->
    <!-- Set total pages -->
    {% set total_pages = (stats.template_stats | length) %}
    <!-- Set previous cycle -->
    {% if previous_cycles %} {% set previous_cycle = previous_cycles[0] %} {%
    else %} {% set previous_cycle = None %} {% endif %}
    <!-- For accessing stats within Javascript -->
    <div style="display: none">
      <p id="indicators">{{ json.dumps(indicators) }}</p>
      <p id="templateStats">{{ json.dumps(stats.template_stats) }}</p>
      <p id="timeIntervalStats">{{ json.dumps(stats.time_stats) }}</p>
      <p id="previousCycles">{{ json.dumps(previous_cycles, default=str) }}</p>
      <p id="currentCycle">{{ json.dumps(cycle, default=str) }}</p>
    </div>

    <!-- Cover Page -->
    <div id="cover-page">
      <img
        id="cover-image"
        src="{{ url_for('static', filename='image/cycle_cover.jpg') }}"
      />
      <p id="cover-assessment">Phishing Campaign Assessment</p>
      <p id="cover-report">Status Report</p>
      <p id="cover-cycle">PCA{{ cycle._id | upper }}</p>
      <p id="cover-date">{{ datetime.utcnow().strftime('%b %d, %Y') }}</p>
      <h2 id="cover-customer">
        {{ customer.name }}
        <span id="cover-identifier">({{ customer.identifier }})</span>
      </h2>
      <div id="cover-bottom">
        <img
          id="cover-logo"
          src="{{ url_for('static', filename='image/cisa_logo.png') }}"
        />
        <p id="cover-box">
          If {{ customer.name }} wishes to create and distribute derivatives of
          this report (such as summaries of this report or {{ customer.name }}’s
          commentary on the report’s recommendations), {{ customer.name }}
          should (1) provide notice to CISA prior to distributing such
          derivatives; (2) clearly mark derivatives so that it is clear that {{
          customer.name }} created them and so that they cannot be mistaken for
          official CISA documents; and (3) refrain from affixing the CISA logo
          or DHS seal to the derivatives, unless {{ customer.name }} has
          obtained written permission to do so from the CISA Office of External
          Affairs. <sup>1</sup>
        </p>
        <div id="cover-divider"></div>
        <p id="cover-use">
          <sup>1</sup> The unauthorized use of any Federal agency’s seal is
          governed by the U.S. Code title 18 sections 506, 701, 709 and 1017.
          Requests to use the CISA logo or DHS seal should be directed to
          branding@cisa.dhs.gov, copying vulnerability_info@cisa.dhs.gov
        </p>
      </div>
    </div>

    <!-- REPORT CARD -->
    <div id="report-card-page">
      <div id="report-card-box"></div>
      <img
        id="report-card-logo"
        src="{{ url_for('static', filename='image/cisa_logo.png') }}"
      />
      <div id="report-card-customer">
        {{ customer.name }}<br /><br />{{ customer.address_1 }}<br />{{
        customer.city }}, {{ customer.state }} {{ customer.zip_code }} USA<br />
        {{ subscription.primary_contact.email }}
      </div>
      <div id="report-card-bottom">
        <div class="d-flex">
          <div class="d-flex flex-column">
            <div style="font-size: 18pt" class="dhs-blue">
              CAMPAIGN TIMELINE
            </div>
            <div class="report-card-changes-text">
              <b>Cycle Start: </b> {{ cycle.start_date.strftime('%b, %d, %Y') }}
            </div>
            <div class="report-card-changes-text">
              <b>Emails Delivered By: </b> {{ cycle.send_by_date.strftime('%b,
              %d, %Y') }}
            </div>
            <div class="report-card-changes-text">
              <b>Cycle End: </b> {{ cycle.end_date.strftime('%b, %d, %Y') }}
            </div>
          </div>
        </div>

        <div
          style="margin-top: 0.25in; margin-bottom: 0.25in"
          id="report-card-horizontal-divider"
        ></div>

        <div class="d-flex">
          <div class="d-flex flex-column">
            <div style="font-size: 18pt" class="dhs-blue">STATISTICS</div>
            <div
              style="font-size: 14pt; margin-top: 0.125in; text-align: center"
            >
              <b>Emails Sent of Total Targets</b>
              <canvas id="doughnut-sent">
                <script>
                  createDoughnut(
                    "doughnut-sent",
                    "{{ stats.stats.all.sent.count }}",
                    "{{ cycle.target_count }}"
                  );
                </script>
              </canvas>
            </div>
          </div>
          <div
            class="d-flex flex-column"
            style="margin-left: 0.65in; margin-right: 0.65in"
          >
            <div style="font-size: 18pt; color: white">Changes</div>
            <div
              style="font-size: 14pt; margin-top: 0.125in; text-align: center"
            >
              <b>Emails Clicked of Sent</b>
              <canvas id="doughnut-clicked">
                <script>
                  createDoughnut(
                    "doughnut-clicked",
                    "{{ stats.stats.all.clicked.count }}",
                    "{{ stats.stats.all.sent.count }}"
                  );
                </script>
              </canvas>
            </div>
          </div>

          <div id="report-card-vertical-divider"></div>
          <div class="d-flex flex-column flex-fill" style="align-items: center">
            <div style="font-size: 18pt" class="dhs-blue">AVERAGE TIME</div>
            <div style="margin-top: 0.125in">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="1.25in"
                height="1.25in"
                fill="currentColor"
                class="bi bi-alarm"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8.5 5.5a.5.5 0 0 0-1 0v3.362l-1.429 2.38a.5.5 0 1 0 .858.515l1.5-2.5A.5.5 0 0 0 8.5 9V5.5z"
                />
                <path
                  d="M6.5 0a.5.5 0 0 0 0 1H7v1.07a7.001 7.001 0 0 0-3.273 12.474l-.602.602a.5.5 0 0 0 .707.708l.746-.746A6.97 6.97 0 0 0 8 16a6.97 6.97 0 0 0 3.422-.892l.746.746a.5.5 0 0 0 .707-.708l-.601-.602A7.001 7.001 0 0 0 9 2.07V1h.5a.5.5 0 0 0 0-1h-3zm1.038 3.018a6.093 6.093 0 0 1 .924 0 6 6 0 1 1-.924 0zM0 3.5c0 .753.333 1.429.86 1.887A8.035 8.035 0 0 1 4.387 1.86 2.5 2.5 0 0 0 0 3.5zM13.5 1c-.753 0-1.429.333-1.887.86a8.035 8.035 0 0 1 3.527 3.527A2.5 2.5 0 0 0 13.5 1z"
                />
              </svg>
            </div>
            {% set avg_time =
            time.convert_seconds(cycle.stats.stats.all.clicked.average) %}
            <div>
              <div style="font-size: 18pt; color: #c1c3c5; margin-top: 9px">
                {{ avg_time.hours }} Hours
              </div>
              <div style="font-size: 18pt; margin-top: 10px">
                {{ avg_time.minutes }} Minutes
              </div>
              <div style="font-size: 18pt; color: #c1c3c5; margin-top: 10px">
                {{ avg_time.seconds }} Seconds
              </div>
            </div>
          </div>
        </div>

        <div
          style="margin-top: 0.25in; margin-bottom: 0.25in"
          id="report-card-horizontal-divider"
        ></div>

        <div class="d-flex">
          <div class="d-flex flex-column">
            <div style="font-size: 18pt" class="dhs-blue">
              STATISTICS BY LEVEL
            </div>
            <div
              style="font-size: 14pt; margin-top: 0.25in; text-align: center"
            >
              <div style="display: none">
                <p id="overallStats">{{ json.dumps(cycle.stats.stats) }}</p>
                <p id="indicatorStats">
                  {{ json.dumps(cycle.stats.indicator_stats) }}
                </p>
                <p id="indicators">{{ json.dumps(indicators) }}</p>
                <p id="templateStats">{{ json.dumps(stats.template_stats) }}</p>
                <p id="timeIntervalStats">{{ json.dumps(stats.time_stats) }}</p>
              </div>
              <div>
                <canvas
                  id="bar-stats-by-level"
                  class="d-flex report-chart"
                  style="height: 20rem"
                >
                  <script>
                    createStatsByLevelChart();
                  </script>
                </canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Templates -->
    {% for template in stats.template_stats | sort(attribute="clicked.ratio",
    reverse=True) %}
    <div class="page">
      {% if loop.index == 1 %}
      <p class="page-header">Top Templates</p>
      {% endif %}

      <table class="template-table" style="margin-left: 0">
        <thead>
          <tr>
            <th colspan="2" style="text-align: center">
              Template #{{ loop.index }} - {{ template.template.name }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Deception Level</td>
            <td>
              {{ template.template.deception_score }} ({{
              template.deception_level | title }})
            </td>
          </tr>
          <tr>
            <td>Total Sent</td>
            <td>{{ template.sent.count }}</td>
          </tr>
          <tr>
            <td>Unique Clicks</td>
            <td>{{ template.clicked.count }}</td>
          </tr>
          <tr>
            <td>Click Rate</td>
            <td>{{ percent(template.clicked.ratio) }}%</td>
          </tr>
          <tr>
            <td>Previous Cycle Click Rate for Level</td>
            <td>
              {% if previous_cycles %} {{
              percent(previous_cycles[0]["stats"]["stats"][template.deception_level]["clicked"]["ratio"])
              }}% {% else %} N/A {% endif %}
            </td>
          </tr>
          <tr>
            <td>CISA average click rate for level</td>
            <td>TBD</td>
          </tr>
          <tr>
            <td>CISA average report rate for level</td>
            <td>TBD</td>
          </tr>
        </tbody>
      </table>
      <div class="template-body">
        <b>Subject:</b>
        {{ preview_template(template.template.subject, customer) }}<br />
        <b style="margin-bottom: 1rem">From:</b>
        {{ preview_from_address(template.template, subscription, customer) }}<br /><br />
        <div class="template-html">{{ template.template.html | safe }}</div>
      </div>
      <p>The following are the <b>Red Flag</b> indicators for the template.</p>
      <ul>
        {% for rec in recommendations %}{% if rec._id in
        template.template.red_flag %}
        <li>{{ rec.title }}</li>
        {% endif %}{% endfor %}
      </ul>
      <p>
        The following are the <b>Sophisticated Techniques</b> used by the
        template.
      </p>
      <ul>
        {% for rec in recommendations %}{% if rec._id in
        template.template.sophisticated %}
        <li>{{ rec.title }}</li>
        {% endif %}{% endfor %}
      </ul>
      <p class="page-number">Page | {{ loop.index }} of {{ total_pages }}</p>
    </div>
    {% endfor %}
  </body>
</html>
